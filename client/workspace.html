
<html>
<head>
<title>Workspace view</title>
<link type="text/css" href="css/workspacestyle.css" rel="stylesheet"></link>

<script src="/webrtc.io.js"></script>
</head>
<body onload="init()">
<div id="notice">This is the workspace view. Choose the appropriate camera and move this window to where you want it.</div>
<div id="videos">
<video id="you" autoplay height="100%"></video>
</div>
<div id="chatbox">
<button id="fullscreen">Enter Full Screen</button>
<!--      <button id="newRoom">Create A New Room</button>
<button id="openWorkspace">Open the workspace</button>
<button id="closeWorkspace">Close the workspace</button>
<button id="inviteUser">Intvite</button>
<button id="leaveRoom">Leave the room</button>	
<div id="messages"> -->
</div>
<br>
<!-- <input id="chatinput" type="text"/> -->
</div>
<script>
var videos = [];
var videoStreams = [];
var rooms = [1,2,3,4,5];
var PeerConnection = window.PeerConnection || window.webkitPeerConnection00;

function cloneVideo(domId, socketId) {
	var video = document.getElementById(domId);
	var clone = video.cloneNode(false);
	clone.id = "remote" + socketId;
	//document.getElementById('videos').appendChild(clone);
	videos.push(clone);
	return clone;
}
function removeVideo(socketId) {
	//   var video = document.getElementById('remote' + socketId);
	var index = -1;
	for (var i = 0; i < videos.length; i++) {
		if ( videos[i].id == 'remote' + socketId){
			index = i;
			break;
		}
	}
	if (index > -1) {
		videoStreams.splice(index, 1);
		videos.splice(index, 1);
	}

	//    if (video) {
	//		videoStreams.splice(videos.indexOf(video),1);
	//        videos.splice(videos.indexOf(video), 1);
	//        video.parentNode.removeChild(video);
	//     }
}

function initFullScreen() { 
	var button = document.getElementById("fullscreen");
	button.addEventListener('click', function(event) {
			var elem = document.getElementById("videos"); 
			//show full screen 
			elem.webkitRequestFullScreen();
			});
} 

function init() {
	if(PeerConnection){

		rtc.createStream({"video": true, "audio": true}, function(stream) {
				document.getElementById('you').src = URL.createObjectURL(stream);
				videos.push(document.getElementById('you'));
				rtc.attachStream(stream, 'you');
				videoStreams.push(stream);
				document.getElementById("notice").innerHTML = "";
				});
	}else {
		alert('Your browser is not supported or you have to turn on flags. In chrome you go to chrome://flags and turn on Enable PeerConnection remember to restart chrome');
	}


	var room = window.location.hash.slice(1);

	//When using localhost
	console.log('Connecting');
	rtc.connect("ws://"+ window.location.host +"/", room);
	//rtc.connect("ws://localhost:8000/", room);

	rtc.on('add remote stream', function(stream, socketId) {
			console.log("ADDING REMOTE STREAM...");
			var clone = cloneVideo('you', socketId);
			//clone.setAttribute("class", "");
			clone.class="";
			//document.getElementById(clone.id).setAttribute("class", "");
			//rtc.attachStream(stream, clone.id);
			var streamUrl = URL.createObjectURL(stream);
			clone.setAttribute("src", streamUrl);
			videoStreams.push(stream);
			});
	rtc.on('disconnect stream', function(data) {
			console.log('remove ' + data);
			removeVideo(data);
			});
	initFullScreen();
}

</script>
</body>
</html>
