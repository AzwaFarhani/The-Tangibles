
<html>
<head>
<title>Workspace view</title>
<link type="text/css" href="css/workspacestyle.css" rel="stylesheet"></link>

<script src="/webrtc.io.js"></script>
</head>
<body onload="init()">
<div id="notice">This is the workspace view. Choose the appropriate camera and move this window to where you want it.</div>
<div id="videos">
<video id="you" autoplay height="100%"></video>
</div>
<div id="chatbox">
<button id="fullscreen">Enter Full Screen</button>
</div>
<br>
</div>
<script>


function Workspace() {
	var videos = [];
	var videoStreams = [];
	var PeerConnection = window.PeerConnection || window.webkitPeerConnection00;

	this.cloneVideo = function (domId, socketId) {
		var video = document.getElementById(domId);
		var clone = video.cloneNode(false);
		clone.id = "remote" + socketId;
		videos.push(clone);
		return clone;
	}

	this.removeVideo = function (socketId) {
		var index = -1;
		for (var i = 0; i < videos.length; i++) {
			if (videos[i].id == 'remote' + socketId) {
				index = i;
				break;
			}
		}
		if (index > -1) {
			videoStreams.splice(index, 1);
			videos.splice(index, 1);
		}
	}

	this.initFullScreen = function () { 
		var button = document.getElementById("fullscreen");
		button.addEventListener('click', function(event) {
				var elem = document.getElementById("videos"); 
				//show full screen 
				elem.webkitRequestFullScreen();
				// TODO start calibration
				// TODO start merging video and display it
				});
	} 

	this.init = function () {
		if (PeerConnection) {

			rtc.createStream({"video": true, "audio": true}, function(stream) {
					document.getElementById('you').src = URL.createObjectURL(stream);
					videos.push(document.getElementById('you'));
					rtc.attachStream(stream, 'you');
					videoStreams.push(stream);
					document.getElementById("notice").innerHTML = "";
					});
		} else {
			alert('Your browser is not supported or you have to turn on flags. In chrome you go to chrome://flags and turn on Enable PeerConnection remember to restart chrome');
		}

		var room = window.location.hash.slice(1);

		//When using localhost
		console.log('Connecting');
		rtc.connect("ws://"+ window.location.host +"/", room);

		rtc.on('add remote stream', function(stream, socketId) {
				console.log("ADDING REMOTE STREAM...");
				// TODO replace cloneVideo
				var clone = cloneVideo('you', socketId);
				clone.class="";
				var streamUrl = URL.createObjectURL(stream);
				clone.setAttribute("src", streamUrl);
				videoStreams.push(stream);
				});
		rtc.on('disconnect stream', function(data) {
				console.log('remove ' + data);
				removeVideo(data);
				});
		initFullScreen();
	}
}

function init() {
	workspace = Workspace();
	workspace.init();
}

</script>
</body>
</html>
