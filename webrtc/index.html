<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>The-Tangibles</title>

<link
	href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css"
	rel="stylesheet" type="text/css" />
<script
	src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
<script
	src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>

<style type="text/css">
.ui-widget {
	font-size: 0.8em;
}

label,input {
	display: block;
}

#call_list {
	position: absolute;
	bottom: 0;
}

#call_list>div>div { /* Auto decline timeout */
	display: inline;
	color: red;
}
</style>

<script>
	var auto_decline_time = 20;
	var rooms = [];
	var remote_users = [];
	var user_name = "User#" + Math.floor((Math.random() * 999) + 1);

	$(function() {
		$("#welcome_message").text("Welcome " + user_name);

		$("#create_room, #change_user_name").button();
		$("#create_room").click(function() {
			$("#dialog_create_room").dialog("open");
		});
		$("#change_user_name").click(function() {
			$("#user_name").val(user_name);
			$("#dialog_select_user_name").dialog("open");
		});

		$("#dialog_select_user_name").dialog({
			autoOpen : false,
			modal : true,
			buttons : {
				OK : function() {
					onChangeUserName($("#user_name").val());
					$(this).dialog("close");
				},
				Cancel : function() {
					$(this).dialog("close");
				}
			}
		});

		$("#dialog_create_room").dialog({
			autoOpen : false,
			modal : true,
			buttons : {
				OK : function() {
					onCreateRoom($("#room_name").val());
					$(this).dialog("close");
				},
				Cancel : function() {
					$(this).dialog("close");
				}
			}
		});

		onLobbyLoad([ [ "Test Room", 1 ], [ "Room 2", 2 ] ], [ [ "Karl", 1 ],
				[ "Jonas", 2 ] ]);
	});

	/*
	 * Changes the user name to a new name if it isn't the empty string.
	 * Called when the user clicks OK in the select user name dialog.
	 *
	 * @new_name - The new user name
	 */
	function onChangeUserName(new_name) {
		console.log("ChangeUserName: " + new_name);

		if (new_name != "") {
			user_name = new_name;
		}
		$("#welcome_message").text("Welcome " + user_name);
	}

	/*
	 * Adds all rooms and remote users to the page.
	 * Should be called when the page is loaded.
	 *
	 * @rooms - A list of pairs [room_name, room_id]
	 * @remote_users - A list of pairs [remote_user_name, remote_user_id]
	 */
	function onLobbyLoad(rooms, remote_users) {
		console.log("Load");

		// Add rooms
		for ( var i = 0; i < rooms.length; i++) {
			onRoomAdd(rooms[i][0], rooms[i][1]);
		}

		// Add users
		for ( var i = 0; i < remote_users.length; i++) {
			onRemoteUserEnter(remote_users[i][0], remote_users[i][1]);
		}
	}

	/*
	 * Lets the user select a room name. The room is then created.
	 * Called when the create room button is clicked.
	 *
	 * @room_name - Name of the new room
	 */
	function onCreateRoom(room_name) {
		console.log("CreateRoom: " + room_name);

		if (room_name != "") {
			// TODO Create room
			document.location += "room/?room=" + room_name;
		}
	}

	/*
	 * Adds a room to the page if the ID doesn't exist.
	 * Should be called when a new room is available on the server.
	 *
	 * @room_name - Name of the added room
	 * @room_id - ID of the added room
	 */
	function onRoomAdd(room_name, room_id) {
		console.log("RoomAdd: " + room_name + " " + room_id);

		// Unique ids
		if ($("#room_list_" + room_id).length != 0) {
			return;
		}

		// Add to list
		rooms.push([ room_name, room_id ]);
		$("<button/>", {
			text : room_name,
			click : function() {
				onRoomClick(room_id);
			}
		}).button().appendTo($("<div/>", {
			id : "room_list_" + room_id
		}).appendTo("#room_list"));
	}

	/*
	 * Delets a room from the page.
	 * Should be called when a room is deleted on the server.
	 *
	 * @room_id - ID of the deleted room
	 */
	function onRoomDelete(room_id) {
		console.log("RoomDelete: " + room_id);

		// Find room with given id
		var index = -1;
		for ( var i = 0; i < rooms.length; i++) {
			if (rooms[i][1] === room_id) {
				index = i;
				break;
			}
		}
		if (index != -1) {
			// Remove from list
			rooms.splice(index, 1);
			$("#room_list_" + room_id).remove();
		}
	}

	/*
	 * Called when a room is clicked.
	 *
	 * @room_id - ID of the room
	 */
	function onRoomClick(room_id) {
		console.log("RoomClick: " + room_id);

		// TODO
		for ( var i = 0; i < rooms.length; i++) {
			if (rooms[i][1] === room_id) {
				console.log("RoomClick found: " + rooms[i][0]);
				break;
			}
		}
	}

	/*
	 * Adds a remote user to the list.
	 * Should be called when a user enters the server.
	 *
	 * @remote_user_name - Name of the remote user that entered
	 * @remote_user_id - ID of the remote user that entered
	 */
	function onRemoteUserEnter(remote_user_name, remote_user_id) {
		console.log("RemoteUserEnter: " + remote_user_name + " "
				+ remote_user_id);

		// Unique ids
		if ($("#remote_user_list_" + remote_user_id).length != 0) {
			return;
		}

		// Add to list
		remote_users.push([ remote_user_name, remote_user_id ]);
		$("<button/>", {
			text : remote_user_name,
			click : function() {
				onRemoteUserClick(remote_user_id);
			}
		}).button().appendTo($("<div/>", {
			id : "remote_user_list_" + remote_user_id
		}).appendTo("#remote_user_list"));
	}

	/*
	 * Removes a remote user from the list.
	 * Should be called when a user leaves the server.
	 *
	 * @remote_user_id - ID of the remote user that left
	 */
	function onRemoteUserLeave(remote_user_id) {
		console.log("RemoteUserLeave: " + remote_user_id);

		// Find remote_user with given id
		var index = -1;
		for ( var i = 0; i < remote_users.length; i++) {
			if (remote_users[i][1] === remote_user_id) {
				index = i;
				break;
			}
		}
		if (index != -1) {
			// Remove from list
			remote_users.splice(index, 1);
			$("#remote_user_list_" + remote_user_id).remove();
		}
	}

	/*
	 * Called when a remote user is clicked.
	 *
	 * @remote_user_id - ID of the remote user
	 */
	function onRemoteUserClick(remote_user_id) {
		console.log("RemoteUserClick: " + remote_user_id);

		// TODO
		for ( var i = 0; i < remote_users.length; i++) {
			if (remote_users[i][1] === remote_user_id) {
				console.log("RemoteUserClick found: " + remote_users[i][0]);
				break;
			}
		}
	}

	/*
	 * Notifies the user that there is an incoming call. A call is auto-declined after a specified time.
	 * Should be called when the user has been invited to a room.
	 *
	 * @remote_user_name - Name of the inviter
	 * @room_name - Name of the room
	 * @call_id - ID of the call
	 */
	function onIncomingCall(remote_user_name, room_name, call_id) {
		console.log("IncomingCall: " + remote_user_name + " " + room_name + " "
				+ call_id);

		// Unique ids
		if ($("#call_" + call_id).length != 0) {
			return;
		}

		// Insert above
		$("<div/>", {
			id : "call_" + call_id,
			text : remote_user_name + " wants you to join " + room_name + "."
		}).append($("<button/>", {
			text : "Accept",
			click : function() {
				onAccept(call_id);
			}
		}).button()).append($("<button/>", {
			text : "Decline",
			click : function() {
				onDecline(call_id);
			}
		}).button()).append($("<div/>", {
			id : "call_timer_" + call_id
		})).prependTo("#call_list");

		// Auto-decline after x seconds
		onAutoDeclineTimer(call_id, auto_decline_time);
	}

	/*
	 * Removes the notification and accepts the call.
	 * Called when the user clicked accept.
	 *
	 * @call_id - ID of the call that was accepted
	 */
	function onAccept(call_id) {
		console.log("Accept: " + call_id);

		if ($("#call_" + call_id).length != 0) { // Extra check
			// TODO Accept
			$("#call_" + call_id).remove();
		}
	}

	/*
	 * Removes the notification and declines the call.
	 * Called when the user clicked decline or when the timeout expired.
	 *
	 * @call_id - ID of the call that was declined
	 */
	function onDecline(call_id) {
		console.log("Decline: " + call_id);

		if ($("#call_" + call_id).length != 0) { // Extra check
			// TODO Decline
			$("#call_" + call_id).remove();
		}
	}

	/*
	 * Counts down the auto-decline timeout by one second.
	 * A counter is displayed when there its less or equal to 10 seconds remaining.
	 *
	 * @call_id - ID of the call
	 * @time_left - Number of seconds left on the timeout
	 */
	function onAutoDeclineTimer(call_id, time_left) {
		if ($("#call_timer_" + call_id).length != 0) { // Might have been manually declined
			time_left--;
			if (time_left <= 0) { // Time is up, decline
				onDecline(call_id);
			} else {
				if (time_left <= 10) { // Only display last 10 seconds
					$("#call_timer_" + call_id).text(time_left);
				}

				setTimeout(function() {
					onAutoDeclineTimer(call_id, time_left);
				}, 1000);
			}
		}
	}
</script>

</head>
<body>
	<div id="dialog_select_user_name" title="Select user name">
		<label for="user_name">User name</label> <input type="text"
			name="user_name" id="user_name"
			class="text ui-widget-content ui-corner-all" />
	</div>
	<div id="dialog_create_room" title="Create new room">
		<label for="room_name">Room name</label> <input type="text"
			name="room_name" id="room_name"
			class="text ui-widget-content ui-corner-all" />
	</div>
	<h1>Lobby</h1>
	<h2 id="welcome_message">Welcome</h2>
	<button id="change_user_name">Change user name</button>
	<button id="create_room">Create room</button>
	<h3>Rooms</h3>
	<div id="room_list"></div>
	<h3>Remote users</h3>
	<div id="remote_user_list"></div>

	<div id="call_list"></div>
</body>
</html>
