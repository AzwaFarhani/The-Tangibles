<html>
  <head>
    <title>Room view</title>
    <link type="text/css" href="/roomstyle.css" rel="stylesheet"></link>
    
    <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css" />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
    <script	src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>

    <script src="/webrtc.io.js"></script>
  </head>
  <body onload="init()">
    <!-- Main content -->
    <div id ="content">
	
      <!-- Videos go here -->
      <div id="videos">   
        <video id="you" class="flip" autoplay></video> 
      </div> 
      <!-- Message box and buttons -->
      <div id="chatbox">  
        <button id="fullscreen">Enter Full Screen</button>     
        <button id="openWorkspace">Open the workspace</button>
        <button id="closeWorkspace">Close the workspace</button>
        <button id="inviteUser">Invite (n√∂jd nu?)</button>
        <button id="leaveRoom">Leave the room</button>
        <div id="messages"></div>
      </div> 
    </div>
    
    <script>
      var videos = [];
      var rooms = [1,2,3,4,5];
      var PeerConnection =  window.PeerConnection || window.webkitPeerConnection00 || window.webkitRTCPeerConnection;
      var user_name = parent.lobby.ownName;
      
      // State variable used to keep track of what to show.
      var state = "lobby";
        
      function getNumPerRow() {
        var len = videos.length;
        var biggest;

        // Ensure length is even for better division.
        if (len % 2 === 1) {
          len++;
        }

        biggest = Math.ceil(Math.sqrt(len));
        while (len % biggest !== 0) {
          biggest++;
        }
        return biggest;
      }

      function subdivideVideos() {
        var perRow = getNumPerRow();
        var numInRow = 0;
        for (var i = 0, len = videos.length; i < len; i++) {
          var video = videos[i];
          setWH(video, i);
          numInRow = (numInRow + 1) % perRow;
        }
      }

      function setWH(video, i) {
        var perRow = getNumPerRow();
        var perColumn = Math.ceil(videos.length / perRow);
        var width = Math.floor((window.innerWidth) / perRow);
        var height = Math.floor((window.innerHeight - 190) / perColumn);
        video.width = width;
        video.height = height;
        video.style.position = "absolute";
        video.style.left = (i % perRow) * width + "px";
        video.style.top = Math.floor(i / perRow) * height + "px";
      }

      function cloneVideo(domId, socketId) {
        var video = document.getElementById(domId);
        var clone = video.cloneNode(false);
        clone.id = "remote" + socketId;
        document.getElementById('videos').appendChild(clone);
        videos.push(clone);
        return clone;
      }
      function removeVideo(socketId) {
        var video = document.getElementById('remote' + socketId);
        if (video) {
            videos.splice(videos.indexOf(video), 1);
            video.parentNode.removeChild(video);
        }
      }

      function addToChat(msg, color) {
        var messages = document.getElementById('messages');
        msg = sanitize(msg);
        if (color) {
          msg = '<span style="color: ' + color + '; padding-left: 15px">' + msg + '</span>';
        } else {
          msg = '<strong style="padding-left: 15px">' + msg + '</strong>';
        }
        messages.innerHTML = messages.innerHTML + msg + '<br>';
        messages.scrollTop = 10000;
      }

      function sanitize(msg) {
        return msg.replace(/</g, '&lt;');
      }

      function initFullScreen() { 
        var button = document.getElementById("fullscreen");
        button.addEventListener('click', function(event) {
          var elem = document.getElementById("videos"); 
          //show full screen 
          elem.webkitRequestFullScreen();
        });
      } 

      function initNewRoom() {
        var button = document.getElementById("newRoom");
        //button.disabled = true;
        button.addEventListener('click', function(event) {

            var chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";
            var string_length = 8;
            var randomstring = '';
            for (var i=0; i<string_length; i++) {
              var rnum = Math.floor(Math.random() * chars.length);
              randomstring += chars.substring(rnum,rnum+1);
            }
            
            window.location.hash = randomstring;
            location.reload();
        })
      }
	  
	  function initOpenWorkspace() {
		var wsbutton = document.getElementById("openWorkspace");
		wsbutton.addEventListener('click', function(event){
			var clbutton = document.getElementById("closeWorkspace");
			clbutton.disabled = false;
			wsbutton.disabled = true;
			var room = window.location.hash.slice(1);
			workspaceWindow=window.open('http://localhost:8000/workspace/#' + room + '_desk');
      writeMessageToChat(user_name + " opened the workspace.");
    })
	  }
	  
	  function initCloseWorkspace() {
      var clbutton = document.getElementById("closeWorkspace");
      clbutton.disabled = true;
      clbutton.addEventListener('click', function(event){
        workspaceWindow.close();
        var wsbutton = document.getElementById("openWorkspace");
        wsbutton.disabled = false;
        clbutton.disabled = true;
      })
	  }
	  
	function onUserInvited(invited_user) {
	    inviting_user = user_name;
		var room = window.location.hash.slice(1);
      
		// See if the user exists
		var uid = -1;
		var list = parent.lobby.users
		for (i in list) {
			if (list[i][1] == invited_user) {
				uid = list[i][0];
				break;
			}
		}
	
		// If the user exists:
		if (uid > -1) {
			parent.socket.send(parent.API_INVITE_SEND, JSON.stringify({
				id:uid,
				roomId:room
			}));
			writeMessageToChat(inviting_user + ' invited ' + invited_user);
			console.log('The user ' + invited_user + '(id:'+uid+') was invited by ' + inviting_user + ' to this room (' + room + ')');
      
		// If the user does not exist:
		} else {
			addToChat("User " + invited_user + " does not exist.");
		}
	}
	  
	  function initInviteUser() {
      var inviteButton = document.getElementById("inviteUser");
      inviteButton.addEventListener('click', function(event) {
        var invited_user = prompt("Enter user to invite: " + parent.lobby.users, "User");
        if (invited_user != '' && invited_user != null) {
          onUserInvited(invited_user);
        }
      })
	  }
	  
	  function initLeaveRoom() {
	    var leaveButton = document.getElementById("leaveRoom");
      leaveButton.addEventListener('click', function(event) {
        writeMessageToChat(user_name + " left the room.");
        console.log('Left the room');
        parent.lobby.leaveRoom();
      })
	  }
	  
	  function writeMessageToChat(message) {
	    var room = window.location.hash.slice(1);
      var color = "#"+((1<<24)*Math.random()|0).toString(16);

      rtc._socket.send(JSON.stringify({
        "eventName": "chat_msg",
        "data": {
        "messages": message,
        "room": room,
        "color": color
        }
      }), function(error) {
        if (error) {
          console.log(error);
        }
      });
      addToChat(message);
	  }

    function initChat() {
      var input = document.getElementById("chatinput");
      var room = window.location.hash.slice(1);
      var color = "#"+((1<<24)*Math.random()|0).toString(16);
  
  /*    input.addEventListener('keydown', function(event) {
        var key = event.which || event.keyCode;
        if (key === 13) {
          rtc._socket.send(JSON.stringify({
            "eventName": "chat_msg",
            "data": {
            "messages": input.value,
            "room": room,
            "color": color
            }
          }), function(error) {
            if (error) {
              console.log(error);
            }
          });
          addToChat(input.value);
          input.value = "";
        }
      }, false); */
      rtc.on('receive_chat_msg', function(data) {
        console.log(data.color);
        addToChat(data.messages, data.color.toString(16));
      });
    }

    function init() {
      console.log("Testing");
      console.log($(window.parent.document).find("#roomMain"));
      if ($(window.parent.document).find("#roomMain").length == 0) {
        console.log("Attempted to access this page without going through the lobby.");
        //window.location.replace("http://www.youtube.com/watch?v=_1mB5rM8WHU");
        initRoom();
      } else {
        initRoom();
      }
    }
	  
	  function initRoom() {
      
	    if(PeerConnection){
		
        rtc.createStream({"video": true, "audio": true}, function(stream) {
          document.getElementById('you').src = URL.createObjectURL(stream);
          videos.push(document.getElementById('you'));
          rtc.attachStream(stream, 'you');
          subdivideVideos();
        });
      }else {
        alert('Your browser is not supported or you have to turn on flags. In chrome you go to chrome://flags and turn on Enable PeerConnection remember to restart chrome');
      }
      var room = window.location.hash.slice(1);
	  
      //When using localhost
      console.log('Connecting');
      rtc.connect("ws://130.240.5.191:8000/", room);
      //rtc.connect("ws://localhost:8000/", room);
	  
      rtc.on('add remote stream', function(stream, socketId) {
        console.log("ADDING REMOTE STREAM...");
        var clone = cloneVideo('you', socketId);
        document.getElementById(clone.id).setAttribute("class", "");
        rtc.attachStream(stream, clone.id);
        subdivideVideos();
		
      });
      rtc.on('disconnect stream', function(data) {
        console.log('remove ' + data);
        removeVideo(data);
      });
      initFullScreen();
      //initNewRoom();
      initChat();
      initOpenWorkspace();
      initCloseWorkspace();
      initInviteUser();
      initLeaveRoom();
    }
    
    window.onresize = function(event) {
      subdivideVideos();
    };
    </script>
  </body>
</html>
