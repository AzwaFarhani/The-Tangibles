
<html>
    
    <head>
        
        <title>Projector Group Test</title>
        
        <script src="sylvester.js"></script>
        <script type="text/javascript" src="mediaext.js"></script>
        <script type="text/javascript" src="geometry.js"></script>
        <script type="text/javascript" src="cv.js"></script>
        <script type="text/javascript" src="aruco.js"></script>
        <script type="text/javascript" src="imageproc.js"></script>
        <script type="text/javascript" src="buttons.js"></script>
        <script type="text/javascript" src="calibration.js"></script>
        
        <script>
            
            var video, detector, imageData;
            var buttons;
            var miniCanvas, miniContext;
            var fullCanvas, fullContext;
            var calibrator;
            
            const CANVAS_WIDTH = 640, CANVAS_HEIGHT = 480;
            
            function init() {
                
                video = MediaExt.getCameraAccess(CANVAS_WIDTH, CANVAS_HEIGHT, tick);
                
                miniCanvas = MediaExt.createCanvas(CANVAS_WIDTH, CANVAS_HEIGHT);
                miniContext = miniCanvas.getContext("2d");
                
                fullCanvas = document.getElementById("myCanvas");
                fullContext = fullCanvas.getContext("2d");
                
                detector = new AR.Detector();
                calibrator = new Calibrator(fullCanvas, video);
                
                fullCanvas.width = window.innerWidth;
                fullCanvas.height = window.innerHeight;
                
                window.onresize = function() {
                    fullCanvas.width = window.innerWidth;
                    fullCanvas.height = window.innerHeight;
                };
            }
            
            
            // Stores an image from the local video stream in imageData
            function snapshot() {
                
                // Draw video to an offscreen canvas, marker detection is done there
                miniContext.drawImage(video, 0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
                imageData = miniContext.getImageData(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
                
                calibrator.draw(imageData);
            }
            
            /* Keeps calibrating until the correct rectangle is found,
            then displays the transformed video stream */
            function tick() {
                snapshot();
                var markers = detector.detect(imageData);
                calibrator.calibrateWithMarkers(markers);
                setTimeout(tick, 1);
            }
            
            // <button type="button" onClick="doneCalibrating();">Done Calibrating</button>
            </script>
        
    </head>
    
    <body style="font-family: monospace; background-color: white;" onLoad="init();">
        
        <center>
            <canvas id ="myCanvas" style="width: 100%; height: 100%"></canvas>
            <button type="button" onClick="calibrator.confirmSharedRectangle();">Done Calibrating</button>
        </center>
        
    </body>

</html>
