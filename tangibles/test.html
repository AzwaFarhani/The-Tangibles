<html>
	<head>
		<meta charset=UTF-8 />
		<title>Test page</title>
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
		<script type="text/javascript" src="tangibleLib.js"></script>
		<script type="text/javascript">
			$(document).ready( function() {
				err = function(e) {console.log(e.msg);}

				
				// Connect to
				api = new TangibleAPI('127.0.0.1');
				devices = [];
				api.register('My API', 'Desc', function(d) {
					setTimeout(register_all_avaliable, 1);
				}, err);
				
				register_all_avaliable = function() {
					api.listDevices(function(d) {
						for (i = 0; i < 6; i++) {
							api.reserveDevice(d.msg[i].id, function (r) {
								console.log('Got device: ' + r.msg);
								devices.push(r.msg);
							}, err);
						}
					}, err);
				}
				
				listenToEvents = function(device_id) {
					api.subscribeToEvents(devices[device_id], function(d) {
						socket = new WebSocket('ws://127.0.0.1:' + d.msg.port + '/streaming');
						socket.onopen = function (evt) {
							console.log('Opened websocket');
							socket.send(JSON.stringify({'flow': 'ctrl', 'msg' : api.getAppUUID()}));
						};
						socket.onerror = function (e) {
							console.log('Error: ' + e.data);
						}
						socket.onclose = function (e) {
							console.log('Close: ' + e.data);
						}
						socket.onmessage = function(e) {
							console.log('Recived: ' + e.data);
							if($.parseJSON(e.data).msg.event == 'pressed') {
								alert("Pressed sifteo!");
							}
						}
					}, err);
				}
				
				// Set colors
				green = function(device_id) {api.showColor(devices[device_id],"00ff00",err,err);}
				blue = function(device_id) {api.showColor(devices[device_id],"0000ff",err,err);}
				red = function(device_id) {api.showColor(devices[device_id],"ff0000",err,err);}
				// Set picture
				picture = function(device_id, url) {api.showPicture(devices[device_id],url,err,err);}
				// Set text
				showText = function(device_id, text, color){api.showText(devices[device_id], text, color, err, err, err);}

				testSifteo = function(device_id){
					console.log("Starting tests with device "+device_id+","+devices[device_id]);

					console.log("Test: color blue");
					blue(device_id);

					setTimeout(function(){
						console.log("Test: show text");
						showText(device_id, "Test text", "0000ff");
					}, 1000);

					setTimeout(function(){
						console.log("Test: show picture");
						picture(device_id, "http://cdn.ghacks.net/wp-content/themes/magatheme/img/mozilla-firefox.png");
					}, 1500);

					
					setTimeout(function(){
						console.log("Test: listen to events");
						listenToEvents(device_id);
					}, 2500);
				}


				// Release devices
				exit = function() {api.releaseAllDevices(err,err);}
				
				window.onbeforeunload = function() {
					exit();
				}
			});
		</script>
	</head>
	<body>
		<p>Test page</p>
		<a href="javascript:exit();">Release all devices by pressing here!</a>
	</body>
</html>
