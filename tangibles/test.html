<html>
<head>
	<meta charset=UTF-8 />
	<title>Test page</title>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script type="text/javascript" src="tangibleLib.js"></script>
	<script type="text/javascript">

var api;
var devices = [];

function err(e) {
	console.log(e.msg);
}

function registerDevices() {
	api.listDevices(function(d) {
		for (var i=0; i < 6; i++) {
			api.reserveDevice(d.msg[i].id, function(r) {
				console.log('Got device: '+r.msg);
				devices.push(r.msg);
			}, err);
		}
		$('#status').val('Registered 6 devices!');
		$('#button_start_sifteo').removeAttr('disabled');
	}, err);
}

function listenToEvents(device_id) {
	api.subscribeToEvents(devices[device_id], function(d) {
		socket = new WebSocket('ws://127.0.0.1:' + d.msg.port + '/streaming');
		socket.onopen = function (evt) {
			console.log('Opened websocket');
			socket.send(JSON.stringify({'flow': 'ctrl', 'msg' : api.getAppUUID()}));
		};
		socket.onerror = function (e) {
			console.log('Error: ' + e.data);
		}
		socket.onclose = function (e) {
			console.log('Close: ' + e.data);
		}
		socket.onmessage = function(e) {
			console.log('Received: ' + e.data);
			if($.parseJSON(e.data).msg.event == 'pressed') {
				console.log("Pressed sifteo!");
			}
		}
	}, err);
}

function setColor(device_id, color) {
	// color = "RRGGBB"
	api.showColor(devices[device_id], color, err, err);
}

function showPicture(device_id, url) {
	api.showPicture(devices[device_id], url, err, err);
}

function showText(device_id, text, color){
	api.showText(devices[device_id], text, color, err, err, err);
}

function testSifteo(device_id) {
	console.log("Starting tests with device "+device_id+","+devices[device_id]);

	console.log("Test: color blue");
	setColor(device_id, "0000ff");

	setTimeout(function(){
		console.log("Test: show text");
		showText(device_id, "Test text", "0000ff");
	}, 1000);

	setTimeout(function(){
		console.log("Test: show picture");
		showPicture(device_id, "http://cdn.ghacks.net/wp-content/themes/magatheme/img/mozilla-firefox.png");
	}, 1500);

	setTimeout(function(){
		console.log("Test: listen to events");
		listenToEvents(device_id);
	}, 2500);
}

function onExit(e) {
	//document.body.style.backgroundColor = 'black';
	$('#status').val('Unregistered');
	api.releaseAllDevices(err, err);
	api.unregister(err, err);
}

$(window).bind('beforeunload', onExit);

$(document).ready(function() {
	// Connect to
	$('#status').val('Connecting to TangibleAPI...');
	api = new TangibleAPI('127.0.0.1');
	api.register('My API', 'Desc', function(d) {
		$('#status').val('Connected!');
		$('#button_register_devices').removeAttr('disabled');
	}, err);
});

	</script>
	<style type="text/css">
#status {
	width: 250px;
}
	</style>
</head>
<body>
	<p>Test page</p>
	<p>Status: <input type="text" id="status" readonly /></p>
	<p><button id="button_register_devices" onclick="registerDevices();" disabled>Register devices</button></p>
	<p><button id="button_start_sifteo" onclick="testSifteo(1);" disabled>Start Sifteo</button></p>
	<p><button onclick="onExit();">Release all devices and unregister</button></p>
</body>
</html>
